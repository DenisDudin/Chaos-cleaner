# Настройка Telegram API для парсинга каналов

## Архитектура авторизации

**Важно**: Пользователи Mini App **НЕ** авторизуются в Telegram API напрямую!

### Как это работает:

1. **Пользователи Mini App**:
   - Уже авторизованы в Telegram (через сам Mini App)
   - Работают только с нашим API (`/api/parse-channels`)
   - **НЕ** вводят коды подтверждения или пароли 2FA

2. **Серверный аккаунт** (настраивается один раз):
   - Авторизуется в Telegram API через MTProto **один раз** при настройке сервера
   - Используется для парсинга каналов от имени всех пользователей
   - Сессия сохраняется на сервере, повторная авторизация не требуется

### Схема работы:

```
Пользователь Mini App → Наш API → Серверный Telegram аккаунт → Telegram API
                         (без авторизации)   (авторизован один раз)
```

## Выбор подхода

Для парсинга Telegram каналов рекомендуется использовать **MTProto (Telegram Client API)**, так как он позволяет:
- Получать полную историю сообщений из каналов
- Работать с любыми каналами, на которые подписан **серверный аккаунт**
- Не требует прав администратора в канале

## Получение credentials для MTProto

### Шаг 1: Получение api_id и api_hash

1. Перейдите на https://my.telegram.org/apps
2. Войдите используя ваш номер телефона Telegram
3. Заполните форму создания приложения:
   - **App title**: ChaosCleaner (или любое другое название)
   - **Short name**: chaoscleaner (латиница, без пробелов)
   - **Platform**: Desktop
   - **Description**: Application for parsing Telegram channels
4. После создания вы получите:
   - **api_id** — числовой ID (например: `12345678`)
   - **api_hash** — строка из 32 символов (например: `abcdef1234567890abcdef1234567890`)

### Шаг 2: Подготовка номера телефона

- Номер должен быть в международном формате: `+1234567890`
- На этот номер придет код подтверждения при первой авторизации

## Настройка в проекте

### Создание .env файла

Создайте файл `back/.env` со следующим содержимым:

```env
# Telegram API credentials (MTProto)
TELEGRAM_API_ID=your_api_id_here
TELEGRAM_API_HASH=your_api_hash_here
TELEGRAM_PHONE=+1234567890

# Опционально: путь к файлу сессии (будет создан автоматически)
TELEGRAM_SESSION_PATH=./data/telegram_session
```

**Важно**: Файл `.env` уже добавлен в `.gitignore`, поэтому он не попадет в git.

## Процесс авторизации (только для настройки сервера)

**Этот процесс выполняется только один раз при настройке сервера администратором!**

При первом запуске сервера с настроенными credentials:

1. Сервер запросит код подтверждения из Telegram (в консоль/логи)
2. Администратор вводит код, который придет в Telegram на номер из `TELEGRAM_PHONE`
3. При необходимости вводится пароль двухфакторной аутентификации (если включена)
4. Сессия сохраняется в файл (указан в `TELEGRAM_SESSION_PATH`)
5. При последующих запусках сервера авторизация не потребуется

**Пользователи Mini App не участвуют в этом процессе!**

## Альтернатива: Telegram Bot API

Если вы хотите использовать Bot API вместо MTProto:

1. Создайте бота через @BotFather в Telegram
2. Получите токен бота
3. Добавьте в `.env`:
   ```env
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   ```

**Ограничения Bot API:**
- Бот должен быть администратором канала ИЛИ
- Канал должен быть публичным и бот подписан на него
- Нет прямого метода для получения истории сообщений

## Безопасность

- **Никогда не коммитьте** `.env` файл в git
- Храните credentials в безопасном месте
- В продакшене используйте переменные окружения или секреты (например, в CI/CD)

## Важные замечания

### Ограничения серверного аккаунта

- Серверный аккаунт может парсить только те каналы, на которые **он подписан**
- Если пользователь хочет парсить канал, на который серверный аккаунт не подписан, нужно:
  - Либо подписать серверный аккаунт на этот канал
  - Либо использовать альтернативный подход (например, Bot API с правами администратора)

### Рекомендации

- Используйте отдельный Telegram аккаунт для серверного парсинга (не личный)
- Подпишите серверный аккаунт на популярные каналы, которые могут запрашивать пользователи
- В будущем можно добавить функционал подписки серверного аккаунта на каналы по запросу пользователей

## Следующие шаги

После получения credentials:
1. Создайте файл `back/.env` с вашими данными
2. Уведомите разработчика для интеграции
3. При первом запуске сервера будьте готовы ввести код подтверждения (это делается один раз!)
4. Подпишите серверный аккаунт на каналы, которые планируете парсить

